name: Roblox Player Watcher

on:
  schedule:
    - cron: "*/5 * * * *"  # runs every 5 minutes
  workflow_dispatch:       # allows manual runs

jobs:
  check-player:
    runs-on: ubuntu-latest

    steps:
      - name: Check Roblox Player and Send Discord Webhook
        env:
          PLACE_ID: ${{ secrets.PLACE_ID }}
          TARGET_USER_ID: ${{ secrets.TARGET_USER_ID }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python3 - <<'PYCODE'
import requests, os, json, sys

place_id = os.getenv("PLACE_ID")
target_id = os.getenv("TARGET_USER_ID")
webhook_url = os.getenv("DISCORD_WEBHOOK")

if not all([place_id, target_id, webhook_url]):
    print("❌ Missing one or more environment variables.")
    sys.exit(1)

found = False
cursor = None

while True:
    url = f"https://games.roblox.com/v1/games/{place_id}/servers/Public?sortOrder=Asc&limit=100"
    if cursor:
        url += f"&cursor={cursor}"

    try:
        response = requests.get(url)
        data = response.json()
    except Exception as e:
        print("❌ Error fetching Roblox API:", e)
        sys.exit(1)

    for server in data.get("data", []):
        for player in server.get("players", []):
            print("Checking player:", player.get("id"))
            if str(player.get("id")) == str(target_id):
                found = True
                break
        if found:
            break

    cursor = data.get("nextPageCursor")
    if not cursor or found:
        break

if found:
    message = f"The player with ID **{target_id}** is currently in the game! <@658358324856619078>"
else:
    message = f"Player **{target_id}** still offline."

print("Result:", message)
requests.post(webhook_url, json={"content": message})
PYCODE
